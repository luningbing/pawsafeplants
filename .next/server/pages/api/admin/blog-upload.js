"use strict";(()=>{var e={};e.id=5948,e.ids=[5948],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},4721:(e,t,r)=>{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>d});var a={};r.r(a),r.d(a,{default:()=>l});var o=r(1802),s=r(7153),n=r(6249),i=r(2885);async function l(e,t){try{if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(200).end();if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let a=e.headers.authorization;if(!a||!a.startsWith("Bearer "))return t.status(401).json({error:"Unauthorized"});let o=a.substring(7);try{if(!r(9344).verify(o,process.env.JWT_SECRET||"your-secret-key-change-in-production").username)return t.status(401).json({error:"Invalid token"})}catch(e){return t.status(401).json({error:"Invalid token"})}let s=(0,i.createClient)("https://rczfbgzghwiqpxihlexs.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio",{auth:{autoRefreshToken:!1,persistSession:!1}});try{await s.storage.createBucket("blog-images",{public:!0,allowedMimeTypes:["image/jpeg","image/png","image/webp","image/gif"]}),console.log("✅ blog-images桶创建成功")}catch(e){console.log("\uD83D\uDCCB blog-images桶已存在或创建失败:",e.message)}let{file:n,title:l,content:u,tags:c}=e.body;if(!n||!l||!u)return t.status(400).json({error:"Missing required fields",required:["file","title","content"]});let d=n.replace(/^data:image\/\w+;base64,/,""),g=Buffer.from(d,"base64"),m=Date.now(),p=`blog-${m}.jpg`;console.log("\uD83D\uDCE4 上传博客图片到blog-images桶...");let{data:f,error:b}=await s.storage.from("blog-images").upload(p,g,{contentType:"image/jpeg",cacheControl:"31536000",upsert:!0});if(b)return console.error("❌ 图片上传失败:",b),t.status(500).json({error:"Image upload failed",details:b.message});let{data:h}=s.storage.from("blog-images").getPublicUrl(p),I=h.publicUrl;console.log("✅ 图片上传成功:",I);try{let{error:e}=await s.from("media_metadata").insert({file_path:I,display_name:`博客封面 - ${l}`,file_type:"blog_cover",created_at:new Date().toISOString()});e?console.warn("⚠️ media_metadata记录失败:",e.message):console.log("✅ media_metadata记录成功")}catch(e){console.warn("⚠️ media_metadata记录异常:",e.message)}try{let e=c?Array.isArray(c)?c:c.split(",").map(e=>e.trim()):[],{data:r,error:a}=await s.from("blog_posts").insert({title:l.trim(),content:u.trim(),cover_image_url:I,tags:e,status:"published",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(a)return console.error("❌ 博客创建失败:",a),t.status(500).json({error:"Blog creation failed",details:a.message});return console.log("✅ 博客创建成功:",r.id),t.status(200).json({success:!0,data:{blog:r,image_url:I}})}catch(e){return console.error("❌ 博客创建异常:",e),t.status(500).json({error:"Blog creation failed",details:e.message})}}catch(e){return console.error("\uD83D\uDEA8 Blog upload API error:",e),t.status(500).json({error:"Internal server error",details:e.message})}}let u=(0,n.l)(a,"default"),c=(0,n.l)(a,"config"),d=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/admin/blog-upload",pathname:"/api/admin/blog-upload",bundlePath:"",filename:""},userland:a})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=4721);module.exports=r})();