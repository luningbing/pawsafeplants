"use strict";(()=>{var e={};e.id=5141,e.ids=[5141],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},3423:(e,t,r)=>{r.r(t),r.d(t,{config:()=>g,default:()=>u,routeModule:()=>c});var s={};r.r(s),r.d(s,{default:()=>l});var a=r(1802),o=r(7153),i=r(6249),n=r(2885);async function l(e,t){try{if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(200).end();if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let s=e.headers.authorization;if(!s||!s.startsWith("Bearer "))return t.status(401).json({error:"Unauthorized"});let a=s.substring(7);try{if(!r(9344).verify(a,process.env.JWT_SECRET||"your-secret-key-change-in-production").username)return t.status(401).json({error:"Invalid token"})}catch(e){return t.status(401).json({error:"Invalid token"})}let o=(0,n.createClient)("https://rczfbgzghwiqpxihlexs.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio",{auth:{autoRefreshToken:!1,persistSession:!1}});try{await o.storage.createBucket("blog-images",{public:!0,allowedMimeTypes:["image/jpeg","image/png","image/webp","image/gif"]}),console.log("✅ blog-images桶创建成功")}catch(e){console.log("\uD83D\uDCCB blog-images桶已存在或创建失败:",e.message)}let{file:i,title:l,content:u,tags:g,slotName:c,blogId:d}=e.body;if(!i)return t.status(400).json({error:"Missing required fields",required:["file"]});let m=i.replace(/^data:image\/\w+;base64,/,""),p=Buffer.from(m,"base64"),f=Date.now(),_=c?`slot-${c}-${f}.jpg`:`blog-${f}.jpg`;console.log("\uD83D\uDCE4 上传图片到blog-images桶...");let{data:b,error:h}=await o.storage.from("blog-images").upload(_,p,{contentType:"image/jpeg",cacheControl:"31536000",upsert:!0});if(h)return console.error("❌ 图片上传失败:",h),t.status(500).json({error:"Image upload failed",details:h.message});let{data:I}=o.storage.from("blog-images").getPublicUrl(_),w=I.publicUrl;console.log("✅ 图片上传成功:",w);try{let{error:e}=await o.from("media_metadata").insert({file_path:w,display_name:c?`博客槽位 - ${c}`:`博客封面 - ${l}`,file_type:c?"blog_slot":"blog_cover",created_at:new Date().toISOString()});e?console.warn("⚠️ media_metadata记录失败:",e.message):console.log("✅ media_metadata记录成功")}catch(e){console.warn("⚠️ media_metadata记录异常:",e.message)}if(c&&d)try{let{data:e,error:r}=await o.from("blog_posts").select("image_slots").eq("id",d).single();if(r)return console.error("❌ 获取现有博客失败:",r),t.status(500).json({error:"Failed to fetch existing blog"});let s={...e.image_slots||{},[c]:w},{error:a}=await o.from("blog_posts").update({image_slots:s,updated_at:new Date().toISOString()}).eq("id",d);if(a)return console.error("❌ 更新image_slots失败:",a),t.status(500).json({error:"Failed to update image slots",details:a.message});return console.log("✅ image_slots更新成功"),t.status(200).json({success:!0,data:{image_url:w,slot_name:c,image_slots:s}})}catch(e){return console.error("❌ 更新image_slots异常:",e),t.status(500).json({error:"Failed to update image slots",details:e.message})}if(!c&&l&&u)try{let e=g?Array.isArray(g)?g:g.split(",").map(e=>e.trim()):[],{data:r,error:s}=await o.from("blog_posts").insert({title:l.trim(),slug:l.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),content:u.trim(),excerpt:u.trim().substring(0,200)+"...",cover_image_url:w,tags:e,status:"published",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(s)return console.error("❌ 博客创建失败:",s),t.status(500).json({error:"Blog creation failed",details:s.message});return console.log("✅ 博客创建成功:",r.id),t.status(200).json({success:!0,data:{blog:r,image_url:w}})}catch(e){return console.error("❌ 博客创建异常:",e),t.status(500).json({error:"Blog creation failed",details:e.message})}return t.status(200).json({success:!0,data:{image_url:w}})}catch(e){return console.error("\uD83D\uDEA8 Blog upload API error:",e),t.status(500).json({error:"Internal server error",details:e.message})}}let u=(0,i.l)(s,"default"),g=(0,i.l)(s,"config"),c=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/admin/blog-upload-new",pathname:"/api/admin/blog-upload-new",bundlePath:"",filename:""},userland:s})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=3423);module.exports=r})();