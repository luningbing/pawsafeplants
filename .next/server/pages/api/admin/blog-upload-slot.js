"use strict";(()=>{var e={};e.id=1105,e.ids=[1105],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9271:(e,t,r)=>{r.r(t),r.d(t,{config:()=>d,default:()=>u,routeModule:()=>g});var o={};r.r(o),r.d(o,{default:()=>l});var a=r(1802),s=r(7153),i=r(6249),n=r(2885);async function l(e,t){try{if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),"OPTIONS"===e.method)return t.status(200).end();if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let o=e.headers.authorization;if(!o||!o.startsWith("Bearer "))return t.status(401).json({error:"Unauthorized"});let a=o.substring(7);try{if(!r(9344).verify(a,process.env.JWT_SECRET||"your-secret-key-change-in-production").username)return t.status(401).json({error:"Invalid token"})}catch(e){return t.status(401).json({error:"Invalid token"})}let{blogId:s,slotName:i,imageData:l}=e.body;if(!s||!i||!l)return t.status(400).json({error:"Missing required fields",required:["blogId","slotName","imageData"]});let u=(0,n.createClient)("https://rczfbgzghwiqpxihlexs.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio",{auth:{autoRefreshToken:!1,persistSession:!1}});try{await u.storage.createBucket("blog-images",{public:!0,allowedMimeTypes:["image/jpeg","image/png","image/webp","image/gif"]}),console.log("✅ blog-images桶创建成功")}catch(e){console.log("\uD83D\uDCCB blog-images桶已存在或创建失败:",e.message)}let d=l.replace(/^data:image\/\w+;base64,/,""),g=Buffer.from(d,"base64"),c=Date.now(),m=`slot-${i}-${c}.jpg`;console.log("\uD83D\uDCE4 上传槽位图片到blog-images桶...");let{data:p,error:f}=await u.storage.from("blog-images").upload(m,g,{contentType:"image/jpeg",cacheControl:"31536000",upsert:!0});if(f)return console.error("❌ 槽位图片上传失败:",f),t.status(500).json({error:"Slot image upload failed",details:f.message});let{data:b}=u.storage.from("blog-images").getPublicUrl(m),h=b.publicUrl;console.log("✅ 槽位图片上传成功:",h);try{let{error:e}=await u.from("media_metadata").insert({file_path:h,display_name:`博客槽位 - ${i}`,file_type:"blog_slot",created_at:new Date().toISOString()});e?console.warn("⚠️ media_metadata记录失败:",e.message):console.log("✅ media_metadata记录成功")}catch(e){console.warn("⚠️ media_metadata记录异常:",e.message)}try{let{data:e,error:r}=await u.from("blog_posts").select("image_slots").eq("id",s).single();if(r)return console.error("❌ 获取现有博客失败:",r),t.status(500).json({error:"Failed to fetch existing blog"});let o={...e.image_slots||{},[i]:h},{error:a}=await u.from("blog_posts").update({image_slots:o,updated_at:new Date().toISOString()}).eq("id",s);if(a)return console.error("❌ 更新image_slots失败:",a),t.status(500).json({error:"Failed to update image slots",details:a.message});return console.log("✅ image_slots更新成功"),t.status(200).json({success:!0,data:{imageUrl:h,slotName:i,imageSlots:o}})}catch(e){return console.error("❌ 更新image_slots异常:",e),t.status(500).json({error:"Failed to update image slots",details:e.message})}}catch(e){return console.error("\uD83D\uDEA8 Blog slot upload API error:",e),t.status(500).json({error:"Internal server error",details:e.message})}}let u=(0,i.l)(o,"default"),d=(0,i.l)(o,"config"),g=new a.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/admin/blog-upload-slot",pathname:"/api/admin/blog-upload-slot",bundlePath:"",filename:""},userland:o})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9271);module.exports=r})();