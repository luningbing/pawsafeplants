"use strict";(()=>{var e={};e.id=7677,e.ids=[7677],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},1045:(e,t,s)=>{s.r(t),s.d(t,{config:()=>n,default:()=>l,routeModule:()=>T});var a={};s.r(a),s.d(a,{default:()=>c});var E=s(1802),i=s(7153),o=s(6249),r=s(2885);async function c(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{console.log("\uD83D\uDD27 å¼€å§‹ä¿®å¤å…¬å¼€å±•ç¤ºè¡¨çš„RLSæƒé™...");let e=(0,r.createClient)("https://rczfbgzghwiqpxihlexs.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});if(!process.env.SUPABASE_SERVICE_ROLE_KEY)return console.error("âŒ ç¯å¢ƒå˜é‡ç¼ºå¤±:",{NEXT_PUBLIC_SUPABASE_URL:!0,SUPABASE_SERVICE_ROLE_KEY:!!process.env.SUPABASE_SERVICE_ROLE_KEY}),t.status(500).json({error:"Environment variables missing",details:{NEXT_PUBLIC_SUPABASE_URL:!0,SUPABASE_SERVICE_ROLE_KEY:!!process.env.SUPABASE_SERVICE_ROLE_KEY}});console.log("âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡");let s=["site_config","atmosphere_images","media_metadata"],a={};for(let t of s)try{let{data:s,error:E}=await e.from(t).select("*").limit(1);E?(console.error(`âŒ è¡¨ ${t} æ£€æŸ¥å¤±è´¥:`,E),a[t]={exists:!1,error:E.message}):(console.log(`âœ… è¡¨ ${t} å­˜åœ¨ä¸”å¯è®¿é—®`),a[t]={exists:!0,count:s?.length||0})}catch(e){console.error(`âŒ è¡¨ ${t} è®¿é—®å¼‚å¸¸:`,e),a[t]={exists:!1,error:e.message}}let E=[`
        -- ç¡®ä¿site_configè¡¨å­˜åœ¨
        CREATE TABLE IF NOT EXISTS public.site_config (
          key TEXT PRIMARY KEY,
          value TEXT,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- å¯ç”¨RLS
        ALTER TABLE public.site_config ENABLE ROW LEVEL SECURITY;
        
        -- åˆ é™¤ç°æœ‰ç­–ç•¥
        DROP POLICY IF EXISTS "site_config_select_policy" ON public.site_config;
        
        -- åˆ›å»ºå…è®¸åŒ¿åç”¨æˆ·SELECTçš„ç­–ç•¥
        CREATE POLICY "site_config_select_policy" ON public.site_config
          FOR SELECT USING (true);
        
        -- æˆäºˆåŒ¿åç”¨æˆ·SELECTæƒé™
        GRANT SELECT ON public.site_config TO anon;
        GRANT SELECT ON public.site_config TO authenticated;
      `,`
        -- ç¡®ä¿atmosphere_imagesè¡¨å­˜åœ¨
        CREATE TABLE IF NOT EXISTS public.atmosphere_images (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          url TEXT,
          title TEXT,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- å¯ç”¨RLS
        ALTER TABLE public.atmosphere_images ENABLE ROW LEVEL SECURITY;
        
        -- åˆ é™¤ç°æœ‰ç­–ç•¥
        DROP POLICY IF EXISTS "atmosphere_images_select_policy" ON public.atmosphere_images;
        
        -- åˆ›å»ºå…è®¸åŒ¿åç”¨æˆ·SELECTçš„ç­–ç•¥
        CREATE POLICY "atmosphere_images_select_policy" ON public.atmosphere_images
          FOR SELECT USING (true);
        
        -- æˆäºˆåŒ¿åç”¨æˆ·SELECTæƒé™
        GRANT SELECT ON public.atmosphere_images TO anon;
        GRANT SELECT ON public.atmosphere_images TO authenticated;
      `,`
        -- ç¡®ä¿media_metadataè¡¨å­˜åœ¨
        CREATE TABLE IF NOT EXISTS public.media_metadata (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          file_path TEXT,
          display_name TEXT,
          is_atmosphere BOOLEAN DEFAULT FALSE,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- å¯ç”¨RLS
        ALTER TABLE public.media_metadata ENABLE ROW LEVEL SECURITY;
        
        -- åˆ é™¤ç°æœ‰ç­–ç•¥
        DROP POLICY IF EXISTS "media_metadata_select_policy" ON public.media_metadata;
        
        -- åˆ›å»ºå…è®¸åŒ¿åç”¨æˆ·SELECTçš„ç­–ç•¥
        CREATE POLICY "media_metadata_select_policy" ON public.media_metadata
          FOR SELECT USING (true);
        
        -- æˆäºˆåŒ¿åç”¨æˆ·SELECTæƒé™
        GRANT SELECT ON public.media_metadata TO anon;
        GRANT SELECT ON public.media_metadata TO authenticated;
      `],i=[];for(let t=0;t<E.length;t++){let a=E[t],o=s[t];try{console.log(`ğŸ”§ æ‰§è¡Œ ${o} è¡¨RLSä¿®å¤...`);let{data:t,error:s}=await e.rpc("exec_sql",{sql_query:a});s?(console.error(`âŒ ${o} RLSä¿®å¤å¤±è´¥:`,s),i.push({table:o,success:!1,error:s.message})):(console.log(`âœ… ${o} RLSä¿®å¤æˆåŠŸ`),i.push({table:o,success:!0,data:t}))}catch(e){console.error(`âŒ ${o} RLSä¿®å¤å¼‚å¸¸:`,e),i.push({table:o,success:!1,error:e.message})}}console.log("\uD83E\uDDEA æµ‹è¯•ä¿®å¤åçš„è®¿é—®æƒé™...");let o={},c=(0,r.createClient)("https://rczfbgzghwiqpxihlexs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio");for(let e of s)try{let{data:t,error:s}=await c.from(e).select("*").limit(1);s?(console.error(`âŒ åŒ¿åè®¿é—® ${e} å¤±è´¥:`,s),o[e]={success:!1,error:s.message}):(console.log(`âœ… åŒ¿åè®¿é—® ${e} æˆåŠŸ`),o[e]={success:!0,count:t?.length||0})}catch(t){console.error(`âŒ åŒ¿åè®¿é—® ${e} å¼‚å¸¸:`,t),o[e]={success:!1,error:t.message}}return t.status(200).json({success:!0,message:"å…¬å±•ç¤ºè¡¨RLSæƒé™ä¿®å¤å®Œæˆ",environment:{NEXT_PUBLIC_SUPABASE_URL:!0,SUPABASE_SERVICE_ROLE_KEY:!!process.env.SUPABASE_SERVICE_ROLE_KEY,NEXT_PUBLIC_SUPABASE_ANON_KEY:!0},tableStatus:a,fixResults:i,testResults:o,recommendations:["æ‰€æœ‰å…¬å±•ç¤ºè¡¨å·²å¯ç”¨RLSå¹¶é…ç½®åŒ¿åè®¿é—®ç­–ç•¥","site_config, atmosphere_images, media_metadataè¡¨å¯æ­£å¸¸è®¿é—®","å»ºè®®å®šæœŸæ£€æŸ¥RLSç­–ç•¥çŠ¶æ€","å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥Vercelç¯å¢ƒå˜é‡é…ç½®"]})}catch(e){return console.error("âŒ RLSä¿®å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:",e),t.status(500).json({error:"RLSä¿®å¤å¤±è´¥",details:e.message,stack:e.stack})}}let l=(0,o.l)(a,"default"),n=(0,o.l)(a,"config"),T=new E.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/admin/fix-public-tables-rls",pathname:"/api/admin/fix-public-tables-rls",bundlePath:"",filename:""},userland:a})},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=1045);module.exports=s})();