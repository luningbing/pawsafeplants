"use strict";(()=>{var e={};e.id=833,e.ids=[833],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9664:(e,t,r)=>{r.r(t),r.d(t,{config:()=>m,default:()=>u,routeModule:()=>c});var a={};r.r(a),r.d(a,{default:()=>l});var s=r(1802),o=r(7153),n=r(6249),i=r(2885);async function l(e,t){try{let r,a;if(t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type"),"OPTIONS"===e.method)return t.status(200).end();if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});console.log("\uD83C\uDF2B️ atmosphere-images API 开始处理请求..."),console.log("\uD83D\uDCCB 环境变量检查:",{NEXT_PUBLIC_SUPABASE_URL:!0,SUPABASE_SERVICE_ROLE_KEY:!!process.env.SUPABASE_SERVICE_ROLE_KEY,NEXT_PUBLIC_SUPABASE_ANON_KEY:!0});let s="https://rczfbgzghwiqpxihlexs.supabase.co",o=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio";if(console.log("\uD83D\uDCCB Supabase配置:",{url:s?"已配置":"未配置",key:o?"已配置":"未配置"}),!s||!o)return console.error("\uD83D\uDEA8 Supabase配置缺失: URL或Key未配置"),t.status(200).json({atmosphere_images:[],count:0,error_type:"environment_missing",error_message:"Supabase环境变量缺失，请检查NEXT_PUBLIC_SUPABASE_URL和SUPABASE_SERVICE_ROLE_KEY"});let n=(0,i.createClient)(s,o,{auth:{autoRefreshToken:!1,persistSession:!1}});console.log("\uD83C\uDF2B️ 获取氛围图数据...");try{console.log("\uD83D\uDD17 尝试连接数据库...");let e=await n.from("media_metadata").select("file_path, display_name, created_at").eq("is_atmosphere",!0).order("created_at",{ascending:!1}).limit(8);if(r=e.data,a=e.error){if(console.error("❌ 数据库查询错误:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a.message?.includes("permission denied")||"42501"===a.code)return console.error("\uD83D\uDEA8 权限拒绝: 需要检查RLS策略"),t.status(200).json({atmosphere_images:[],count:0,error_type:"permission_denied",error_message:"RLS权限问题，需要配置匿名访问策略",error_details:a.message});if(a.message?.includes("does not exist")||"42P01"===a.code)return console.error("\uD83D\uDEA8 表不存在: media_metadata表需要创建"),t.status(200).json({atmosphere_images:[],count:0,error_type:"table_not_found",error_message:"media_metadata表不存在，需要创建表和RLS策略",error_details:a.message})}}catch(e){if(console.error("❌ 数据库连接失败:",{message:e.message,stack:e.stack}),!process.env.SUPABASE_SERVICE_ROLE_KEY)return console.error("\uD83D\uDEA8 环境变量缺失: SUPABASE_URL或SUPABASE_SERVICE_ROLE_KEY未配置"),t.status(200).json({atmosphere_images:[],count:0,error_type:"environment_missing",error_message:"环境变量缺失，请检查SUPABASE_URL和SUPABASE_SERVICE_ROLE_KEY",error_details:e.message});r=null,a=e}if(a){console.warn("⚠️ 数据库查询失败，使用默认图片:",a.message);let e=[{url:"/images/hero/cat-main.jpg",title:"Cozy Cat Corner",createdAt:new Date().toISOString()},{url:"/images/hero/cat-main.jpg",title:"Happy Cat Home",createdAt:new Date().toISOString()},{url:"/images/hero/cat-main.jpg",title:"Pet-Friendly Plants",createdAt:new Date().toISOString()},{url:"/images/hero/cat-main.jpg",title:"Cat Safe Garden",createdAt:new Date().toISOString()},{url:"/images/hero/cat-main.jpg",title:"Cozy Living Room",createdAt:new Date().toISOString()},{url:"/images/hero/cat-main.jpg",title:"Happy Cat Home",createdAt:new Date().toISOString()},{url:"/images/hero/cat-main.jpg",title:"Pet-Friendly Plants",createdAt:new Date().toISOString()}];return t.status(200).json({atmosphere_images:e,count:e.length,data_source:"default_images",error_type:"database_error",error_message:"数据库查询失败，使用默认图片",error_details:a.message})}let l=(r||[]).map(e=>({url:e.file_path||e.url||"/images/hero/cat-main.jpg",title:e.display_name||"Atmosphere Image",createdAt:e.created_at}));return console.log(`✅ 成功获取 ${l.length} 张氛围图`),t.status(200).json({atmosphere_images:l,count:l.length,data_source:"database"})}catch(e){return console.error("\uD83C\uDF2B️ Atmosphere images API error:",{message:e.message,stack:e.stack}),t.status(200).json({atmosphere_images:[],count:0,error_type:"api_error",error_message:"API服务异常",error_details:e.message,fallback_used:!0})}}process.env.SUPABASE_SERVICE_ROLE_KEY;let u=(0,n.l)(a,"default"),m=(0,n.l)(a,"config"),c=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/atmosphere-images",pathname:"/api/atmosphere-images",bundlePath:"",filename:""},userland:a})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9664);module.exports=r})();