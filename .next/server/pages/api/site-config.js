"use strict";(()=>{var e={};e.id=4707,e.ids=[4707],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},6249:(e,o)=>{Object.defineProperty(o,"l",{enumerable:!0,get:function(){return function e(o,r){return r in o?o[r]:"then"in o&&"function"==typeof o.then?o.then(o=>e(o,r)):"function"==typeof o&&"default"===r?o:void 0}}})},4359:(e,o,r)=>{r.r(o),r.d(o,{config:()=>S,default:()=>p,routeModule:()=>h});var t={};r.r(t),r.d(t,{default:()=>m});var s=r(1802),n=r(7153),a=r(6249),i=r(7147),l=r.n(i),c=r(1017),u=r.n(c),g=r(2885);async function m(e,o){try{o.setHeader("Cache-Control","no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"),o.setHeader("Pragma","no-cache"),o.setHeader("Expires","0"),console.log("\uD83D\uDD27 site-config API 开始处理请求..."),console.log("\uD83D\uDCCB 环境变量检查:",{NEXT_PUBLIC_SUPABASE_URL:!0,SUPABASE_SERVICE_ROLE_KEY:!!process.env.SUPABASE_SERVICE_ROLE_KEY,NEXT_PUBLIC_SUPABASE_ANON_KEY:!0});let r=u().join(process.cwd(),"content","site.json");if("GET"===e.method){let e="https://rczfbgzghwiqpxihlexs.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio";if(console.log("\uD83D\uDD27 获取site-config配置..."),console.log("\uD83D\uDCCB Supabase配置:",{url:e?"已配置":"未配置",key:t?"已配置":"未配置"}),e&&t)try{let r=(0,g.createClient)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}});console.log("\uD83D\uDD17 尝试连接数据库...");let{data:s,error:n}=await r.from("site_config").select("key,value").in("key",["heroImage","logo"]);if(n){if(console.error("❌ 数据库查询错误:",{message:n.message,details:n.details,hint:n.hint,code:n.code}),n.message?.includes("permission denied")||"42501"===n.code)return console.error("\uD83D\uDEA8 权限拒绝: 需要检查RLS策略"),o.status(200).json({heroImage:"",logo:"",error_type:"permission_denied",error_message:"RLS权限问题，需要配置匿名访问策略",error_details:n.message});if(n.message?.includes("does not exist")||"42P01"===n.code)return console.error("\uD83D\uDEA8 表不存在: site_config表需要创建"),o.status(200).json({heroImage:"",logo:"",error_type:"table_not_found",error_message:"site_config表不存在，需要创建表和RLS策略",error_details:n.message});console.warn("⚠️ 数据库查询失败，使用本地文件:",n?.message)}else{let e=Object.create(null);return(s||[]).forEach(o=>{e[o.key]=o.value}),console.log("✅ 从数据库获取配置:",{heroImage:e.heroImage,logo:e.logo}),o.status(200).json({heroImage:String(e.heroImage||"").trim(),logo:String(e.logo||"").trim(),data_source:"database"})}}catch(e){if(console.error("❌ 数据库连接失败:",{message:e.message,stack:e.stack}),!process.env.SUPABASE_SERVICE_ROLE_KEY)return console.error("\uD83D\uDEA8 环境变量缺失: SUPABASE_URL或SUPABASE_SERVICE_ROLE_KEY未配置"),o.status(200).json({heroImage:"",logo:"",error_type:"environment_missing",error_message:"环境变量缺失，请检查SUPABASE_URL和SUPABASE_SERVICE_ROLE_KEY",error_details:e.message})}else console.error("\uD83D\uDEA8 Supabase配置缺失: URL或Key未配置");try{let e=JSON.parse(l().readFileSync(r,"utf8"));return console.log("\uD83D\uDCC1 使用本地配置文件:",e),o.status(200).json({...e,data_source:"local_file"})}catch(e){return console.warn("⚠️ 本地配置文件读取失败，使用默认值:",e?.message),o.status(200).json({heroImage:"",logo:"",data_source:"default"})}}if("POST"===e.method){if(!(e.cookies&&"1"===e.cookies.psp_admin||(e.headers.cookie||"").includes("psp_admin=1")))return o.status(401).json({error:"unauthorized"});let t=e.body;if("string"==typeof t)try{t=JSON.parse(t)}catch{}let s="https://rczfbgzghwiqpxihlexs.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjemZiZ3pnaHdpcXB4aWhsZXhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk5NDUwMSwiZXhwIjoyMDc5NTcwNTAxfQ.uF3IofVn0ZkFSM6aSYsWCmOWHl26ybxv_bwMST3Zsio";if(s&&n)try{let e=(0,g.createClient)(s,n,{auth:{autoRefreshToken:!1,persistSession:!1}}),r=[];if(Object.prototype.hasOwnProperty.call(t||{},"heroImage")&&r.push({key:"heroImage",value:String((t||{}).heroImage||"").trim()}),Object.prototype.hasOwnProperty.call(t||{},"logo")&&r.push({key:"logo",value:String((t||{}).logo||"").trim()}),r.length){let{error:t}=await e.from("site_config").upsert(r,{onConflict:"key"});if(t)return console.error("❌ 更新site_config失败:",t),o.status(500).json({error:String(t.message||t)});console.log("✅ site_config更新成功")}let{data:a}=await e.from("site_config").select("key,value").in("key",["heroImage","logo"]),i=Object.create(null);return(a||[]).forEach(e=>{i[e.key]=e.value}),o.status(200).json({heroImage:String(i.heroImage||"").trim(),logo:String(i.logo||"").trim()})}catch(e){return console.error("❌ POST数据库操作失败:",e),o.status(500).json({error:"Database operation failed"})}let a={heroImage:"",logo:""};try{a=JSON.parse(l().readFileSync(r,"utf8"))}catch{}let i=Object.prototype.hasOwnProperty.call(t||{},"heroImage"),c=Object.prototype.hasOwnProperty.call(t||{},"logo"),m=i?String((t||{}).heroImage||"").trim():String(a.heroImage||""),p=c?String((t||{}).logo||"").trim():String(a.logo||""),S={heroImage:m,logo:p};try{l().mkdirSync(u().dirname(r),{recursive:!0})}catch{}return l().writeFileSync(r,JSON.stringify(S,null,2)),o.status(200).json(S)}return o.status(405).json({error:"Method not allowed"})}catch(e){return console.error("site-config API error:",e),o.status(200).json({heroImage:"",logo:"",error_fallback:!0,error_message:String(e?.message||e)})}}let p=(0,a.l)(t,"default"),S=(0,a.l)(t,"config"),h=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/site-config",pathname:"/api/site-config",bundlePath:"",filename:""},userland:t})},7153:(e,o)=>{var r;Object.defineProperty(o,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,o,r)=>{e.exports=r(145)}};var o=require("../../webpack-api-runtime.js");o.C(e);var r=o(o.s=4359);module.exports=r})();