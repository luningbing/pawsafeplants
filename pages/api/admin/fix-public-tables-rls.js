import { createClient } from '@supabase/supabase-js';

// ğŸ”§ ä¿®å¤å…¬å¼€å±•ç¤ºè¡¨çš„RLSæƒé™é—®é¢˜
export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    console.log('ğŸ”§ å¼€å§‹ä¿®å¤å…¬å¼€å±•ç¤ºè¡¨çš„RLSæƒé™...');

    const supabaseAdmin = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY,
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false
        }
      }
    );

    // 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
    if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.SUPABASE_SERVICE_ROLE_KEY) {
      console.error('âŒ ç¯å¢ƒå˜é‡ç¼ºå¤±:', {
        NEXT_PUBLIC_SUPABASE_URL: !!process.env.NEXT_PUBLIC_SUPABASE_URL,
        SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY
      });
      return res.status(500).json({ 
        error: 'Environment variables missing',
        details: {
          NEXT_PUBLIC_SUPABASE_URL: !!process.env.NEXT_PUBLIC_SUPABASE_URL,
          SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY
        }
      });
    }

    console.log('âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡');

    // 2. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
    const tables = ['site_config', 'atmosphere_images', 'media_metadata'];
    const tableStatus = {};

    for (const tableName of tables) {
      try {
        const { data, error } = await supabaseAdmin
          .from(tableName)
          .select('*')
          .limit(1);

        if (error) {
          console.error(`âŒ è¡¨ ${tableName} æ£€æŸ¥å¤±è´¥:`, error);
          tableStatus[tableName] = { exists: false, error: error.message };
        } else {
          console.log(`âœ… è¡¨ ${tableName} å­˜åœ¨ä¸”å¯è®¿é—®`);
          tableStatus[tableName] = { exists: true, count: data?.length || 0 };
        }
      } catch (err) {
        console.error(`âŒ è¡¨ ${tableName} è®¿é—®å¼‚å¸¸:`, err);
        tableStatus[tableName] = { exists: false, error: err.message };
      }
    }

    // 3. æ‰§è¡ŒRLSä¿®å¤SQL
    const fixRLSQueries = [
      // site_configè¡¨RLSç­–ç•¥
      `
        -- ç¡®ä¿site_configè¡¨å­˜åœ¨
        CREATE TABLE IF NOT EXISTS public.site_config (
          key TEXT PRIMARY KEY,
          value TEXT,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- å¯ç”¨RLS
        ALTER TABLE public.site_config ENABLE ROW LEVEL SECURITY;
        
        -- åˆ é™¤ç°æœ‰ç­–ç•¥
        DROP POLICY IF EXISTS "site_config_select_policy" ON public.site_config;
        
        -- åˆ›å»ºå…è®¸åŒ¿åç”¨æˆ·SELECTçš„ç­–ç•¥
        CREATE POLICY "site_config_select_policy" ON public.site_config
          FOR SELECT USING (true);
        
        -- æˆäºˆåŒ¿åç”¨æˆ·SELECTæƒé™
        GRANT SELECT ON public.site_config TO anon;
        GRANT SELECT ON public.site_config TO authenticated;
      `,
      
      // atmosphere_imagesè¡¨RLSç­–ç•¥
      `
        -- ç¡®ä¿atmosphere_imagesè¡¨å­˜åœ¨
        CREATE TABLE IF NOT EXISTS public.atmosphere_images (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          url TEXT,
          title TEXT,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- å¯ç”¨RLS
        ALTER TABLE public.atmosphere_images ENABLE ROW LEVEL SECURITY;
        
        -- åˆ é™¤ç°æœ‰ç­–ç•¥
        DROP POLICY IF EXISTS "atmosphere_images_select_policy" ON public.atmosphere_images;
        
        -- åˆ›å»ºå…è®¸åŒ¿åç”¨æˆ·SELECTçš„ç­–ç•¥
        CREATE POLICY "atmosphere_images_select_policy" ON public.atmosphere_images
          FOR SELECT USING (true);
        
        -- æˆäºˆåŒ¿åç”¨æˆ·SELECTæƒé™
        GRANT SELECT ON public.atmosphere_images TO anon;
        GRANT SELECT ON public.atmosphere_images TO authenticated;
      `,
      
      // media_metadataè¡¨RLSç­–ç•¥
      `
        -- ç¡®ä¿media_metadataè¡¨å­˜åœ¨
        CREATE TABLE IF NOT EXISTS public.media_metadata (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          file_path TEXT,
          display_name TEXT,
          is_atmosphere BOOLEAN DEFAULT FALSE,
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );
        
        -- å¯ç”¨RLS
        ALTER TABLE public.media_metadata ENABLE ROW LEVEL SECURITY;
        
        -- åˆ é™¤ç°æœ‰ç­–ç•¥
        DROP POLICY IF EXISTS "media_metadata_select_policy" ON public.media_metadata;
        
        -- åˆ›å»ºå…è®¸åŒ¿åç”¨æˆ·SELECTçš„ç­–ç•¥
        CREATE POLICY "media_metadata_select_policy" ON public.media_metadata
          FOR SELECT USING (true);
        
        -- æˆäºˆåŒ¿åç”¨æˆ·SELECTæƒé™
        GRANT SELECT ON public.media_metadata TO anon;
        GRANT SELECT ON public.media_metadata TO authenticated;
      `
    ];

    const fixResults = [];

    for (let i = 0; i < fixRLSQueries.length; i++) {
      const query = fixRLSQueries[i];
      const tableName = tables[i];
      
      try {
        console.log(`ğŸ”§ æ‰§è¡Œ ${tableName} è¡¨RLSä¿®å¤...`);
        
        // ä½¿ç”¨RPCæ‰§è¡ŒSQL
        const { data, error } = await supabaseAdmin.rpc('exec_sql', { sql_query: query });
        
        if (error) {
          console.error(`âŒ ${tableName} RLSä¿®å¤å¤±è´¥:`, error);
          fixResults.push({ 
            table: tableName, 
            success: false, 
            error: error.message 
          });
        } else {
          console.log(`âœ… ${tableName} RLSä¿®å¤æˆåŠŸ`);
          fixResults.push({ 
            table: tableName, 
            success: true, 
            data 
          });
        }
      } catch (err) {
        console.error(`âŒ ${tableName} RLSä¿®å¤å¼‚å¸¸:`, err);
        fixResults.push({ 
          table: tableName, 
          success: false, 
          error: err.message 
        });
      }
    }

    // 4. æµ‹è¯•ä¿®å¤åçš„è®¿é—®æƒé™
    console.log('ğŸ§ª æµ‹è¯•ä¿®å¤åçš„è®¿é—®æƒé™...');
    const testResults = {};

    // åˆ›å»ºåŒ¿åå®¢æˆ·ç«¯æµ‹è¯•
    const anonClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
    );

    for (const tableName of tables) {
      try {
        const { data, error } = await anonClient
          .from(tableName)
          .select('*')
          .limit(1);

        if (error) {
          console.error(`âŒ åŒ¿åè®¿é—® ${tableName} å¤±è´¥:`, error);
          testResults[tableName] = { success: false, error: error.message };
        } else {
          console.log(`âœ… åŒ¿åè®¿é—® ${tableName} æˆåŠŸ`);
          testResults[tableName] = { success: true, count: data?.length || 0 };
        }
      } catch (err) {
        console.error(`âŒ åŒ¿åè®¿é—® ${tableName} å¼‚å¸¸:`, err);
        testResults[tableName] = { success: false, error: err.message };
      }
    }

    return res.status(200).json({
      success: true,
      message: 'å…¬å±•ç¤ºè¡¨RLSæƒé™ä¿®å¤å®Œæˆ',
      environment: {
        NEXT_PUBLIC_SUPABASE_URL: !!process.env.NEXT_PUBLIC_SUPABASE_URL,
        SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
        NEXT_PUBLIC_SUPABASE_ANON_KEY: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
      },
      tableStatus,
      fixResults,
      testResults,
      recommendations: [
        'æ‰€æœ‰å…¬å±•ç¤ºè¡¨å·²å¯ç”¨RLSå¹¶é…ç½®åŒ¿åè®¿é—®ç­–ç•¥',
        'site_config, atmosphere_images, media_metadataè¡¨å¯æ­£å¸¸è®¿é—®',
        'å»ºè®®å®šæœŸæ£€æŸ¥RLSç­–ç•¥çŠ¶æ€',
        'å¦‚ä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥Vercelç¯å¢ƒå˜é‡é…ç½®'
      ]
    });

  } catch (error) {
    console.error('âŒ RLSä¿®å¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    return res.status(500).json({ 
      error: 'RLSä¿®å¤å¤±è´¥', 
      details: error.message,
      stack: error.stack
    });
  }
}
